---
title: "PEC1 GSE46687"
author: "Dani Ibañez"
date: "9/4/2021"
output: html_document
---


```{r setup, include=FALSE, echo=FALSE, fig.width = 10, fig.height = 10, out.width = "400px", out.height="300px",fig.align='center'}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, eval = TRUE, warning = FALSE, comment=NA)

```
<br>

### DESCRIPCIÓN DEL ESTUDIO: Síndrome de Turner

<br>

#### **descripción general**

El síndrome de Turner és una patología descubierta por el propio endocrinólogo Henry Turner que afecta solo a mujeres y que se detecta, principalmente, por unos pliegues en el cuello en niñas pequeñas o recién nacidas y en un crecimiento que se para prematuramente quedando con estaturas claramente inferiores a la media. Esterilidad, extremidades hinchadas, genitales y mamas subdesarrolladas, son algunas otras características clínicas.

Aunque se describió esta patología en 1938, fue en 1959 cuando un grupo de científicos descubrieron la principal característica para su detección rápida. Se trata de personas que solo tienen un cromosoma X completo, pudiendo tener parte del segundo o la mayoría con un solo cromosoma sexual X. Es por ello que se identifican como personas con 45 cromosomas (45X). Si el cromosoma X único o entero viene del padre hablaremos de genotipo 45xp, y si procede de la madre hablaremos de genotipo 45Xm.

Parece demostrado que no es hereditario, pero a su vez se considera que la mayoría de incidencia es causada por el cromosoma X aportado por el padre, por lo que se considera que son patologías generadas o en el proceso de meiosis de los padres o en las primeras fases de multiplicación embrionaria. Esta segunda opción podría explicar por qué algunas mujeres presentan células con los dos cromosomas XX y otras células sin uno de ellos.

No hay un tratamiento específico definido si bien, el principal problema que es la baja estatura responde a tratamientos de estimulación de hormona del crecimiento.

<br>

#### **descripción del estudio**

Al margen de los problemas de nacimiento, parece que existe predisposición de padecer enfermedades más graves como problemas cardiovasculares, diabetes o enfermedades de caracter autoinmune. Con este objetivo se realizan estudios de expresión génica comparando muestras de pacientes con esta patología.

En concreto, los científicos 	Cheng CM, Zhou J, Bondy C y otros, realizaron un análisis basado en 36 muestras distribuidas como sigue:

- 10 muestras de 10 mujeres con ambos cromosomas XX ("normales" 46,XX) que nos sirven de referencia.
- 16 muestras de 16 mujeres con un solo cromosoma X de procedencia materna 45,Xm
- 10 muestras de 10 mujeres con un solo cromosoma X de procedencia paterna 45,Xp

El experimento está realizado sobre microarray de affymetrix U133 versión 2.0 (GPL570) y se ha registrado en GEO con el repositorio GSE46687

Como ampliación de la información, el probe set U133 2.0 contiene un catálogo ampliado respecto la primera versión de U133. En este caso hablamos de 47.000 tránscritos distintos que se corresponden con 38.500 genes. 

**subset del estudio**

Para realizar el ejercicio de la PEC1, se ha extraído un subset de la muestra total de 36. En concreto se va a trabajar con una selección aleatoria de 6 muestras de cada uno de los 3 tipos, es decir 18 muestras, 6 XX (mujeres con los dos cromosomas X), 6 Xm (mujeres con un único cromosoma de origen materno) y 6 Xp (6 mujeres con un único cromosoma de origen paterno). Como se indica más abajo esta subselección aleatoria se ha realizado en base al número IDP de la UOC del alumno, en mi caso **IDP: 1083627** 


#### **Documentación**
  
Para realizar el estudio he utilizado como guía la seguida por el Sr. Alex Sánchez en el estudio del caso GSE100924:

https://aspteaching.github.io/Omics_Data_Analysis-Case_Study_1-Microarrays/Case_Study_1-Microarrays_Analysis.html

Al final del documento se citan otras referencias usadas.

En el presente documento HTML no aparece el código, que se adjunta como archvio **rmd** aparte.


__________________________________________________________________________________________________

<br>

### PREPARACIÓN DE ENTORNO DE TRABAJO Y LECTURA DE DATOS

<br>


### Creación del espacio de trabajo

La gran cantidad de información nos "obliga" a estructurar la información en directorios. podemos seguir el convenio habitual en crear un directorio **data** y un directorio **results**. Además el proceso de workflow generará otros directorios que iremos viendo.


```{r espacio de trabajo}

setwd("C:/MASTER/OMICAS/ENTREGA PEC1")
if (!dir.exists("data")) {dir.create("data")}
if (!dir.exists("results")) {dir.create("results")}

```

### Subset de muestras

Tal como hemos informado antes, para este estudio se nos indica trabajar con un subset de las 36 muestras originales. En concreto nos piden aplicar la función del enunciado usando nuestro número IDP.


En mi caso: **IDP: 1083627**

```{r selección subset mediante idp}

selectSamples<- function (myID){
 set.seed(myID)
 selected <- c(sample(1:10, 6),11, sample(12:26, 5), sample(27:36,6)) 
 selected <- sort(selected)
 }
 
samples_idp = selectSamples(1083627)
cat("las muestras seleccionadas son las números",samples_idp)
```

<br>
  
  
A partir de aquí establecemos nuestro set de muestras personalizado con las 18 columnas concretas obtenidas.
Comprobamos cuales son y presentamos la tabla de los valores Phenodata:
  
<br>



```{r subset 18 muestras targets}

targetsAll <-read.csv(file="./data/targetsAll.csv", row.names = 1, head=TRUE)
#row.names(targetsAll)
targets18 <- targetsAll[samples_idp,] # cogemos solo las columnas marcadas por el IDP
#length(targets18)
#row.names(targets18)
colnames(targets18)[1]<-"sample_id"
colnames(targets18)
#class(targets18)
#rownames(targets18)
muestras <- targets18$sample_id

knitr::kable(targets18, booktabs = TRUE, caption = 'Subset de muestras seleccionadas para la PEC1 para IDP:1083627')

```



### Carga de paquetes Bioconductor


```{r carga de paquetes}

if (!requireNamespace("BiocManager", quietly = TRUE))
     install.packages("BiocManager")
# BiocManager::install()

if(!(require(knitr))) install.packages("knitr")
if(!(require(colorspace))) install.packages("colorspace")
if(!(require(gplots))) install.packages("gplots")
if(!(require(ggplot2))) install.packages("ggplot2")
if(!(require(ggrepel))) install.packages("ggrepel")
if(!(require(htmlTable))) install.packages("htmlTable")
if(!(require(prettydoc))) install.packages("prettydoc")
if(!(require(devtools))) install.packages("devtools")
if(!(require(BiocManager))) install.packages("BiocManager")

# install.packages("Rtools")
# BiocManager::install("oligo")
# BiocManager::install("pd.mogene.2.1.st")
# BiocManager::install("arrayQualityMetrics")
# BiocManager::install("pvca")


# PAQUETES NECESARIOS PARA EL ANALISIS

# BiocManager::install("limma")
# BiocManager::install("genefilter")
# BiocManager::install("mogene21sttranscriptcluster.db")
# BiocManager::install("annotate")
# BiocManager::install("org.Mm.eg.db")
# BiocManager::install("ReactomePA")
# BiocManager::install("reactome.db")

```


### lectura de los archivos CEL correspondientes a nuestra selección


```{r carga de datos de las muestras en bruto}

library(oligo)
celFiles <- list.celfiles("./data", full.names = TRUE)
celFiles
library(Biobase)
my.targets <-read.AnnotatedDataFrame(file.path("./data","targets18.csv"), header = TRUE, row.names = 1, sep=",") 
my.targets
row.names(my.targets)
colnames(my.targets)
rawData <- read.celfiles(celFiles, phenoData = my.targets)
class(rawData)

rownames(pData(rawData))
colnames(rawData)
knitr::kable(pData(rawData), booktabs = TRUE, caption = 'Subset de muestras seleccionadas para la PEC1 para IDP:1083627')
pData(rawData)

#my.targets@data$sample_id-> rownames(pData(rawData))
muestras -> rownames(pData(rawData))
colnames(rawData) <-rownames(pData(rawData)) 
head(pData(rawData))
rawData
colnames(rawData)
head(rownames(exprs(rawData)),100)
head(exprs(rawData),100)
tail(exprs(rawData),20)
dim(exprs(rawData))

colnames(exprs(rawData))
```

```{r control de calidad}

#library(arrayQualityMetrics)
#arrayQualityMetrics(rawData, force=TRUE)
``` 


```{r graficando posibles singularidades o errores boxplot}

boxraw <- boxplot(rawData, cex.axis=0.5, las=2,  which="all", 
          col = c(rep("coral2", 6), rep("aquamarine3", 6), rep("darkkhaki", 6)),
          main="Distribution of raw intensity values")
boxraw

class(boxraw)
dim(boxraw)
head(boxraw,20)
```

```{r normalització}

eset_rma <- rma(rawData)
#arrayQualityMetrics(eset_rma, force=TRUE)


boxnorm <-boxplot(eset_rma, cex.axis=0.5, las=2,  which="all", 
          col = c(rep("coral2", 6), rep("aquamarine3", 6), rep("darkkhaki", 6)),
          main="Boxplot for arrays intensity: Normalized Data")

boxnorm
```





```{r funcion plotCA3}

library(ggplot2)
library(ggrepel)

plotPCA3 <- function (datos, labels, factor, title, scale,colores, size = 1.5, glineas = 0.25) {
   data <- prcomp(t(datos),scale=scale)
   # plot adjustments
   dataDf <- data.frame(data$x)
   Group <- factor
   loads <- round(data$sdev^2/sum(data$sdev^2)*100,1)
   # main plot
   p1 <- ggplot(dataDf,aes(x=PC1, y=PC2)) +
     theme_classic() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(data$x[,1])-5,max(data$x[,1])+5)) +
     scale_fill_discrete(name = "Group")
   # avoiding labels superposition
   p1 + geom_text_repel(aes(y = PC2 + 0.25, label = labels),segment.size = 0.25, size = size) + 
     labs(x = c(paste("PC1",loads[1],"%")),y=c(paste("PC2",loads[2],"%"))) +  
     ggtitle(paste("Principal Component Analysis for: ",title,sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5)) +
     scale_color_manual(values=colores)
   }
```

```{r graficando posibles singularidades o errores mediante PCA}

plotPCA3(exprs(rawData), labels = targets18$sample_id, factor = targets18$karyotype, 
          title="Raw data", scale = FALSE, size = 3, 
          colores = c("coral2","aquamarine3","darkkhaki"))

plotPCA3(exprs(eset_rma), labels = targets18$sample_id, factor = targets18$karyotype, 
        title="Normalized data", scale = FALSE, size = 4, 
        colores = c("coral2","aquamarine3","darkkhaki"))
```

```{r analisis de eset_rma}


rownames(pData(eset_rma))
colnames(eset_rma)
knitr::kable(pData(eset_rma), booktabs = TRUE, caption = 'Subset de muestras seleccionadas para la PEC1 para IDP:1083627')
pData(eset_rma)

#my.targets@data$sample_id-> rownames(pData(eset_rma))
muestras -> rownames(pData(eset_rma))
colnames(eset_rma) <-rownames(pData(eset_rma)) 
head(pData(eset_rma))
eset_rma
colnames(eset_rma)
head(rownames(exprs(eset_rma)),100)
head(exprs(eset_rma),100)
tail(exprs(eset_rma),20)
dim(exprs(eset_rma))

colnames(exprs(eset_rma))
head(annotation(eset_rma),10)
```



```{r graficos y control calidad (Hierarchical)}

clust.euclid.average <- hclust(dist(t(exprs(eset_rma))),method="average")
plot(clust.euclid.average, labels=colnames(exprs(eset_rma)), main="Hierarchical clustering of samples",  hang=-1, cex=0.7)

```


```{r graficos y control calidad (Histogramas)}

affySampleNames <- rownames(pData(eset_rma))

affyColores <- c(1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3)

affyLineas <- c(1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3)

hist(rawData, main="Signal distribution", col=affyColores, lty=affyLineas)

legend (x="topright", legend=affySampleNames , col=affyColores, lty=affyLineas, cex=0.7)
```


```{r visualització dels gens que més varien respecte els que menys varien}

sds <- apply (exprs(eset_rma), 1, sd)
sdsO<- sort(sds)
plot(1:length(sdsO), sdsO, main="Distribution of variability for all genes",
      sub="Vertical lines represent 90% and 95% percentiles",
      xlab="Gene index (from least to most variable)", ylab="Standard deviation")
abline(v=length(sds)*c(0.9,0.95))
```


```{r filtrem i ens quedem els únics que varien 2}
#BiocManager::install("hgu133plus2.db")
library(genefilter)
library("hgu133plus2.db")
annotation(eset_rma) <- "hgu133plus2.db"
list_filtered <- nsFilter(eset_rma, require.entrez = TRUE, remove.dupEntrez = TRUE, var.filter=TRUE, var.func=IQR, var.cutoff=0.75,filterByQuantile=TRUE, feature.exclude = "^AFFX")
class(rawData)
class(eset_rma)
class(list_filtered)
eset_filtered <- list_filtered$eset
print(list_filtered$filter.log)

```



```{r analisis de eset_filtered}


rownames(pData(eset_filtered))
colnames(eset_filtered)
knitr::kable(pData(eset_filtered), booktabs = TRUE, caption = 'Subset de muestras seleccionadas para la PEC1 para IDP:1083627')
pData(eset_filtered)

#my.targets@data$sample_id-> rownames(pData(eset_filtered))
muestras -> rownames(pData(eset_filtered))
colnames(eset_filtered) <-rownames(pData(eset_filtered)) 
head(pData(eset_filtered))
eset_filtered
colnames(eset_filtered)
head(rownames(exprs(eset_filtered)),100)
head(exprs(eset_filtered),100)
tail(exprs(eset_filtered),20)
dim(exprs(eset_filtered))

colnames(exprs(eset_filtered))
head(annotation(eset_filtered),10)
```

```{r guardar los archvivos filtrados para el analisis}

write.csv(exprs(eset_rma), file="./results/normalized.Data.csv")
write.csv(exprs(eset_filtered), file="./results/normalized.Filtered.Data.csv")
save(eset_rma, eset_filtered, file="./results/normalized.Data.Rda")
```

```{r contruyendo la matriz de contrastes}

if (!exists("eset_filtered")) load (file="./results/normalized.Data.Rda")
library(limma)
designMat<- model.matrix(~0+X.karyotype., pData(eset_filtered))
colnames(designMat) <- c("XX", "Xp", "Xm")
print(designMat)

cont.matrix <- makeContrasts(p_vs_m = Xp-Xm, xx_vs_X = XX-(Xp+Xm), INT = (Xp-Xm) - (XX-(Xp+Xm)),levels=designMat)
print(cont.matrix)
```


```{r fit}
library(limma)
fit<-lmFit(eset_filtered, designMat)
fit.main<-contrasts.fit(fit, cont.matrix)
fit.main<-eBayes(fit.main)
class(fit.main)
colnames(fit.main)
```


```{r volcano grafic}

library(hgu133plus2.db)
geneSymbols <- select(hgu133plus2.db, rownames(fit.main), c("SYMBOL"))
SYMBOLS<- geneSymbols$SYMBOL
volcanoplot(fit.main, coef=1, highlight=4, names=rownames(fit.main), 
             main=paste("Differentially expressed genes", colnames(cont.matrix)[1], sep="\n"))
abline(v=c(-1,1))
```


```{r res}
res<-decideTests(fit.main, method="separate", adjust.method="fdr", p.value=0.1, lfc=1)

sum.res.rows<-apply(abs(res),1,sum)
res.selected<-res[sum.res.rows!=0,] 
print(summary(res))

vennDiagram (res.selected[,1:3], cex=0.9)
title("Genes in common between the three comparisons\n Genes selected with FDR < 0.1 and logFC > 1")

```


```{r heatmap}

probesInHeatmap <- rownames(res.selected)
HMdata <- exprs(eset_filtered)[rownames(exprs(eset_filtered)) %in% probesInHeatmap,]
 
geneSymbols <- select(hgu133plus2.db, rownames(HMdata), c("SYMBOL"))
SYMBOLS<- geneSymbols$SYMBOL
rownames(HMdata) <- SYMBOLS
write.csv(HMdata, file = file.path("./results/data4Heatmap.csv"))

my_palette <- colorRampPalette(c("blue", "red"))(n = 299)
library(gplots)
 
heatmap.2(HMdata,
           Rowv = FALSE,
           Colv = FALSE,
           main = "Differentially expressed genes \n FDR < 0,1, logFC >=1",
           scale = "row",
           col = my_palette,
           sepcolor = "white",
           sepwidth = c(0.05,0.05),
           cexRow = 0.5,
           cexCol = 0.9,
           key = TRUE,
           keysize = 1.5,
           density.info = "histogram",
           ColSideColors = c(rep("red",6),rep("blue",6), rep("green",6)),
           tracecol = NULL,
           dendrogram = "none",
           srtCol = 30)
```